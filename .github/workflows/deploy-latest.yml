name: Deploy on push to latest

on:
  push:
    branches:
      - latest

jobs:
  deploy:
    name: Deploy to remote server
    runs-on: ubuntu-latest
    steps:
      - name: Debug - Check secrets
        run: |
          echo "SSH_HOST length: ${#SSH_HOST}"
          echo "SSH_USER length: ${#SSH_USER}"
          echo "SSH_PASSWORD length: ${#SSH_PASSWORD}"
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      
      - name: Execute remote deploy commands via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          timeout: 30s  # 添加超时设置
          script: |
            echo "当前目录: $(pwd)"
            echo "用户: $(whoami)"
            
            # 检查目录是否存在
            if [ ! -d "/root/code/tvpage" ]; then
              echo "错误: /root/code/tvpage 目录不存在"
              ls -la /root/code/ || echo "/root/code 也不存在"
              exit 1
            fi
            
            cd /root/code/tvpage
            echo "进入目录: $(pwd)"
            
            # 检查 git 仓库状态
            git status || echo "git 命令失败"
            
            # 执行部署命令
            git reset --hard
            git pull origin latest
            npm run rebuild:start