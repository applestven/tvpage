# 功能接口对接（使用 Next.js 代理）

本项目部署架构为：浏览器 → Next.js（公网） → tv / dv（ZeroTier 内网）。
因此前端不应直接访问内网 IP，而是通过 Next.js 提供的代理接口访问内网服务：

- 下载服务（DV）代理路径：/api/dv/*  → 由服务端代理到内部 DV（通过环境变量 DV_INTERNAL 配置，默认 http://192.168.191.168:3456）
- 转码/转写服务（TV）代理路径：/api/tv/*  → 由服务端代理到内部 TV（通过环境变量 TV_INTERNAL 配置，默认 http://192.168.191.168:6789）

本文件中的示例已统一改为通过上述代理路径进行调用。请在部署时在 Next.js 运行环境中设置 DV_INTERNAL 和 TV_INTERNAL（仅服务器端可见）。

1. 概要流程

- 用户在前端粘贴视频链接或上传文件。
- 若是链接：前端调用 /api/dv/download 提交下载任务并轮询 /api/dv/task/{id} 获取状态；下载完成后得到一个可由 Next.js 代理访问的音频 URL（或由代理内部读取并转发）。
- 若是上传：前端直接将文件上传到 /api/tv/tts/upload 创建转写任务。
- 转写任务创建后，前端通过 /api/tv/tts/sse?id={ttsId} 订阅 SSE 获取实时转写流（EventSource 指向同域 /api/tv/...）。
- 转写完成后，前端通过 /api/tv/tts/{id} 或 /api/tv/tts/detail/{id} 查询任务详情并获取输出文件名（output_name），通过 /api/tv/static/{output_name} 下载字幕或调用 /api/tv/tts/srt-to-txt?file=... 获取纯文本用于复制。

2. 示例（下载任务返回示例 — 注意：示例中的 fullPath 不应直接暴露给浏览器；应由 Next.js 代理转发或返回可访问的代理路径）

示例返回（服务器内部表示）:
{
  "id": "cb854c05-b87d-4fe7-9e63-31fff95ef4f0",
  "url": "https://v.douyin.com/XZVpfWQaPLE/",
  "quality": "audio_worst",
  "status": "success",
  "location": "http://192.168.191.168",
  "error": null,
  "createdAt": 1766994357319,
  "startedAt": 1766994357608,
  "finishedAt": 1766994387451,
  "strategy": "puppeteerStrategy",
  "output": "downloads/2025-12-29T07-46-19.666Z.mp3",
  "outputName": "2025-12-29T07-46-19.666Z.mp3",
  "fullPath": "http://192.168.191.168:3456/downloads/2025-12-29T07-46-19.666Z.mp3"
}

说明：以上 fullPath 为内网可访问地址，浏览器不可直接打开。前端应将该路径交给 Next.js 后端代理，或在后端将其转换为同域的代理地址，例如：/api/dv/downloads/2025-12-29T07-46-19.666Z.mp3，前端通过该代理地址下载。

3. 转写与 SSE

- 当转写状态为 running 时，前端停止轮询详情接口，改为订阅 SSE：/api/tv/tts/sse?id={ttsId}。
- SSE 返回的日志中会包含类似下面的转写片段（解析：[start.s -> end.s] text）：

[23:21:16] 状态: running
  转写输出:
    [254.10s -> 257.10s] 纵使被龙卷锋打的面目全非意识模糊
    [257.10s -> 260.10s] 但他依旧死死抓住阻拦锁不愿松手

- 当 SSE 返回状态 success 时，前端应关闭 SSE，并再次调用详情接口 /api/tv/tts/{id} 获取最终的 output_name。

4. 下载字幕与复制文本（已改为代理）

- 下载字幕（遵循代理）：浏览器打开 /api/tv/static/${result.output_name} 或通过 window.open('/api/tv/static/' + output_name)；不要直接使用内网域名。
- 复制文本：前端调用 /api/tv/tts/srt-to-txt?file=${encodeURIComponent(output_name)}（同域代理），拿到纯文本后写入剪切板（兼容移动与桌面）。

5. 开发与调试建议

- 本地开发时，默认代理内部地址为：
  - DV_INTERNAL=http://127.0.0.1:3456（如果在本机运行 DV 服务）
  - TV_INTERNAL=http://127.0.0.1:6789（如果在本机运行 TV 服务）
- 在真实部署（公网 Next.js）时，将 DV_INTERNAL/TV_INTERNAL 指向 ZeroTier 内网地址（例：http://192.168.191.168:3456 / http://192.168.191.168:6789），确保 Next.js 服务器能够访问内网服务。

6. 小结

- 所有前端请求均应走同域的 /api/dv 或 /api/tv，由 Next.js 在服务器端代理到内网。
- 避免在前端暴露内网 IP 或直接请求内网地址。后端代理可以统一做鉴权、日志、以及对返回路径的转换以便浏览器访问。