# 任务流程

本文档详细描述了tvpage系统中视频转文字任务的完整流程。

## 整体架构

系统采用前后端分离架构：
- 前端：Next.js应用负责用户界面和任务控制
- 后端：内部服务处理实际的视频下载、转码和转录任务
- 代理：Next.js API路由作为代理，将前端请求转发到内部服务

## 任务流程详解

### 1. 任务创建阶段

#### 1.1 用户输入
- 用户通过[VideoInput](file:///d:/code/github/tvpage/src/components/VideoInput.tsx#L13-L93)组件提供视频源，支持两种方式：
  - URL链接输入
  - 本地文件上传

#### 1.2 任务初始化
- 当用户点击提交按钮时，[startTask](file:///d:/code/github/tvpage/src/app/page.tsx#L293-L415)函数被触发
- 根据输入类型（URL或文件）进入不同的处理分支

#### 1.3 URL输入处理流程
- 设置状态为`queueing`（排队中）
- 进入`downloading`（下载中）状态
- 通过`/api/dv/download`接口向内部服务提交下载任务
- 接收到下载任务ID后，开始轮询该任务状态

#### 1.4 本地文件处理流程
- 设置状态为`uploading`（上传中）
- 通过`/api/tv/tts/upload`接口上传文件到内部服务
- 接收转录任务ID，准备建立SSE连接

### 2. 视频下载与转录阶段

#### 2.1 下载任务轮询
- 使用[pollDvTask](file:///d:/code/github/tvpage/src/app/page.tsx#L126-L155)函数轮询下载任务状态
- 每隔2秒检查一次，直到任务完成
- 根据内部服务返回的状态更新UI状态：
  - `pending`/`running` → `downloading`
  - `success` → 获取下载文件路径
  - `failed` → 错误处理

#### 2.2 转录任务创建
- 一旦下载完成，获得音频文件URL
- 通过`/api/tv/tts/task`接口创建转录任务
- 接收转录任务ID，准备建立SSE连接和轮询

#### 2.3 轮询转录任务状态
- 启动[pollTTSTask](file:///d:/code/github/tvpage/src/app/page.tsx#L157-L196)轮询转录任务状态
- 每3秒检查一次任务状态
- 根据内部服务返回的状态执行不同操作：
  - `running` → 启动SSE连接并停止轮询
  - `success` → 获取输出文件名，标记结果就绪
  - `failed` → 错误处理

### 3. SSE连接建立阶段

#### 3.1 SSE连接初始化
- 当轮询到任务状态为`running`时，或在SSE错误恢复时，使用[connectSSE](file:///d:/code/github/tvpage/src/app/page.tsx#L172-L287)函数建立SSE连接
- 通过`/api/tv/tts/sse?id={ttsId}`建立事件流连接
- 设置状态为`transcribing`（转录中）
- 重置进度百分比和成功计数

#### 3.2 SSE连接管理
- 关闭任何现有的SSE连接，防止重复连接
- 设置`stoppedRef.current = false`标记连接活动状态
- 将SSE实例保存到[sseRef](file:///d:/code/github/tvpage/src/app/page.tsx#L31-L31)中以便后续管理
- 使用[successCountRef](file:///d:/code/github/tvpage/src/app/page.tsx#L45-L45)跟踪成功消息数量

### 4. 实时转录数据接收阶段

#### 4.1 数据处理机制
- SSE的[onmessage](file:///d:/code/github/tvpage/src/app/page.tsx#L189-L317)处理器接收实时转录数据
- 验证连接状态，如果已停止则忽略消息
- 解析JSON格式的消息数据

#### 4.2 时间戳格式支持
SSE消息支持多种时间戳格式：

1. **Whisper样式**: `[12.34s -> 13.56s] text`
2. **ttx样式**: `[03:54 → 03:56] text`

#### 4.3 转录片段解析
- 检查[data.logs](file:///d:/code/github/tvpage/src/app/page.tsx#L197-L198)或[data.content](file:///d:/code/github/tvpage/src/app/page.tsx#L197-L198)数组中的日志行
- 使用正则表达式匹配时间戳格式
- 解析开始时间、结束时间和文本内容
- 将新片段添加到转录列表中

#### 4.4 进度跟踪
- 接收`duration`字段更新总时长
- 根据当前转录位置计算完成百分比
- 更新UI上的进度指示器

#### 4.5 成功状态处理
- 当接收到`status: "success"`消息时，增加成功计数
- 只有成功计数达到3次时，才最终关闭SSE连接并标记任务完成
- 这确保了所有转录结果都能完整传递

### 5. 轮询转录任务阶段

#### 5.1 轮询机制启动
- 在创建转录任务后，启动[pollTTSTask](file:///d:/code/github/tvpage/src/app/page.tsx#L157-L196)轮询
- 每3秒检查一次任务状态，直到收到`running`状态或任务完成
- 根据内部服务返回的状态更新UI状态：
  - `running` → 启动SSE连接并停止轮询
  - `success` → 获取输出文件名，标记结果就绪
  - `failed` → 错误处理

### 6. 任务完成处理阶段

#### 6.1 成功状态检测
- 通过SSE（成功计数达到3次）或轮询接收到`status: "success"`消息时：
  - 设置状态为`completed`（已完成）
  - 完成进度至100%
  - 关闭SSE连接
  - 存储输出文件名

#### 6.2 任务详情查询
- 通过SSE完成时会调用[fetchTaskDetail](file:///d:/code/github/tvpage/src/app/page.tsx#L150-L161)获取任务详细信息
- 通过轮询完成时会直接获取任务详细信息
- 获取[outputName](file:///d:/code/github/tvpage/src/app/page.tsx#L44-L44)，用于后续下载

#### 6.3 结果可用性标志
- 当获取到有效的[outputName](file:///d:/code/github/tvpage/src/app/page.tsx#L44-L44)后，设置[resultReady](file:///d:/code/github/tvpage/src/app/page.tsx#L26-L26)为`true`
- 这使得下载和复制按钮变为可用状态

### 7. 结果操作阶段

#### 7.1 下载字幕文件
- 用户点击"下载字幕"按钮
- 通过`/api/tv/static/{outputName}`获取字幕文件
- 在新窗口中打开字幕文件链接

#### 7.2 复制文本内容
- 用户点击"复制文本"按钮
- 通过`/api/tv/tts/srt-to-txt?file={outputName}`获取纯文本内容
- 使用现代Clipboard API或传统方法复制到剪贴板

## 错误处理机制

### 重试策略
- 对于关键操作（如任务创建、文件上传），实现重试机制
- 使用[withRetry](file:///d:/code/github/tvpage/src/app/page.tsx#L344-L365)函数，最多重试3次，每次间隔1秒
- 在控制台记录每次重试的信息

### 多重保障
- 采用轮询+SSE的混合机制确保任务状态同步
- 首先通过轮询检查任务状态，当状态变为`running`时启动SSE连接并停止轮询
- 如果SSE连接中断，轮询机制作为备用方案继续监控任务状态
- 发生错误时，设置状态为`error`，并在控制台记录错误详情

## API代理机制

### 路径映射
- `/api/tv/[...path]` → 内部转录服务（默认`http://43.139.236.50:8686/tv`）
- `/api/dv/[...path]` → 内部下载服务（默认`http://43.139.236.50:8686/dv`）

### 请求转发
- 保持原始请求的所有头部信息（排除hop-by-hop头部）
- 支持请求体的流式传输
- 防止代理循环（检查主机名是否与当前相同）

### 响应处理
- 透传响应头部（过滤hop-by-hop头部）
- 对SSE响应设置`cache-control: no-cache`禁用缓存
- 保持响应体的流式传输